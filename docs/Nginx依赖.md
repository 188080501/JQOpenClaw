# Nginx 依赖说明

本文档整合了 Nginx 文件服务的依赖说明、接口约定、部署配置与联调方法。

## 1. 依赖用途

- 承接节点截图文件上传（`PUT /upload/*`）
- 提供截图文件访问（`GET /files/*`）
- 对上传接口进行 `X-Token` 鉴权

## 2. 系统架构

客户端 -> HTTPS(<自定义端口>) -> Nginx -> 本地文件系统 `/srv/openclaw/data/`

Nginx 在当前方案中负责：

- HTTPS 证书终止
- 上传鉴权
- PUT 文件落盘（WebDAV）
- GET 文件读取

## 3. 关联文件

- 配置模板：`docs/data.conf`
- Node 参数：`--file-server-uri`、`--file-server-token`

## 4. 与 Node 参数映射

Node 侧截图上传依赖两个参数：

- `fileServerUri`：文件服务基础地址，例如 `https://files.example.com:<custom_port>`
- `fileServerToken`：上传时写入请求头 `X-Token`

路径拼接规则：

- 上传地址：`<fileServerUri>/upload/<auto-generated-filename>.jpg`
- 访问地址：`<fileServerUri>/files/<auto-generated-filename>.jpg`

## 5. HTTP 接口约定

### 5.1 上传接口（鉴权）

- 方法：`PUT`
- 路径：`/upload/<filename>`
- Header：`X-Token: <token>`
- Body：文件二进制内容

示例：

```powershell
curl -k -X PUT ^
  -H "X-Token: CHANGE_ME_TOKEN" ^
  --data-binary @test.bin ^
  https://127.0.0.1:<custom_port>/upload/test.bin
```

### 5.2 访问接口（不鉴权）

- 方法：`GET`
- 路径：`/files/<filename>`
- 当前配置不校验 Token

示例：

```powershell
curl -k ^
  https://127.0.0.1:<custom_port>/files/test.bin ^
  -o test.bin
```

## 6. 状态码约定

| 状态码 | 说明 |
| --- | --- |
| 200 | 下载成功 |
| 201 / 204 | 上传成功 |
| 400 | 非法路径（包含 `..`） |
| 401 | 上传未提供 Token |
| 403 | 上传 Token 错误 |
| 404 | 文件不存在 |
| 405 | 请求方法不允许 |

## 7. 文件命名建议

- 推荐使用时间戳、UUID 或业务唯一 ID
- 不允许包含 `..`
- 不建议使用特殊字符

示例：

```text
20260301_171500.bin
550e8400-e29b-41d4-a716-446655440000.bin
```

## 8. 配置与部署

按 `docs/data.conf` 配置以下关键项：

- `ssl_certificate` / `ssl_certificate_key`
- `set $auth_token`
- `alias /srv/openclaw/data/`
- `client_max_body_size`

部署步骤：

1. 准备 Nginx 与 HTTPS 证书
2. 创建存储目录并授予 Nginx 用户读写权限
3. 应用 `docs/data.conf` 并重载 Nginx
4. 进行上传/下载联调

## 9. 快速联调

```powershell
# 上传
curl -k -X PUT ^
  -H "X-Token: CHANGE_ME_TOKEN" ^
  --data-binary @a.bin ^
  https://127.0.0.1:<custom_port>/upload/a.bin

# 下载
curl -k ^
  https://127.0.0.1:<custom_port>/files/a.bin ^
  -o a.bin
```

## 10. 风险与建议

- `GET /files/*` 不鉴权时，URL 可被直接访问，需评估公开范围。
- 建议使用高强度随机 token，且不要提交到仓库。
- 生产环境建议使用可信证书并启用严格 TLS 校验。
- 如需更强保护，可增加 IP 白名单、签名 URL 或对象存储鉴权方案。
