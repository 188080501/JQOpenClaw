server {
    listen 10038 ssl;
    server_name _;

    ssl_certificate     /etc/nginx/ssl/your-domain/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/your-domain/privkey.pem;

    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    client_max_body_size 0;

    # ===== 强制 Token：只认 Header（最简单最稳定）=====
    # 客户端必须带：X-Token: <TOKEN>
    set $auth_token "CHANGE_ME_TOKEN";

    # ===== CORS（可按需删减）=====
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, PUT, OPTIONS" always;
    add_header Access-Control-Allow-Headers "*" always;

    if ($request_method = OPTIONS) { return 204; }

    location ^~ /upload/ {
        # 防目录穿越
        if ($uri ~* "\.\.") { return 400; }

        if ($http_x_token = "") { return 401; }
        if ($http_x_token != $auth_token) { return 403; }

        dav_methods PUT;
        dav_access user:rw group:rw all:r;

        alias /srv/openclaw/data/;
    }

    location ^~ /files/ {
        if ($uri ~* "\.\.") { return 400; }

        alias /srv/openclaw/data/;
        autoindex off;
        try_files $uri =404;
    }
}
